---
title: "Clean Pluto Data"
author: "Liam Purkey"
date: "5/18/2021"
output: html_document
---

#Setup File

```{r, setup, include=FALSE}
#Change root directory
knitr::opts_knit$set(root.dir = "/Users/liampurkey/Desktop/Research/Gentrification")
```

```{r}
#Load packages
library(magrittr)
library(readxl)
library(readr)
library(tidyverse)
library(sf)
library(spData)
library(tmap)
library(purrr)
library(furrr)
source("Code/Scripts/utils.R")
```

```{r}
#Read in pluto data
pluto_bk = read_csv("RawData/pluto/bk11v2.txt", 
                    col_types = cols_only(CT2010 = col_double(), ZoneDist1 = col_character(), Overlay1 = col_character(), LotArea = col_double(), SchoolDist = col_double())) %>%
  filter(!is.na(CT2010) & !is.na(ZoneDist1)) 
pluto_bx = read_csv("RawData/pluto/bx11v2.txt", 
                    col_types = cols_only(CT2010 = col_double(), ZoneDist1 = col_character(), Overlay1 = col_character(), LotArea = col_double(), SchoolDist = col_double())) %>%
  filter(!is.na(CT2010) & !is.na(ZoneDist1)) 
pluto_mn = read_csv("RawData/pluto/mn11v2.txt", 
                    col_types = cols_only(CT2010 = col_double(), ZoneDist1 = col_character(), Overlay1 = col_character(), LotArea = col_double(), SchoolDist = col_double())) %>%
  filter(!is.na(CT2010) & !is.na(ZoneDist1)) 
pluto_qn = read_csv("RawData/pluto/qn11v2.txt", 
                    col_types = cols_only(CT2010 = col_double(), ZoneDist1 = col_character(), Overlay1 = col_character(), LotArea = col_double(), SchoolDist = col_double())) %>%
  filter(!is.na(CT2010) & !is.na(ZoneDist1)) 
pluto_si = read_csv("RawData/pluto/si11v2.txt", 
                    col_types = cols_only(CT2010 = col_double(), ZoneDist1 = col_character(), Overlay1 = col_character(), LotArea = col_double(), SchoolDist = col_double())) %>%
  filter(!is.na(CT2010) & !is.na(ZoneDist1)) 
```

#Create Zoning Data

##Brooklyn

```{r}
zoning_pluto_bk %>%
  clean.zoning(zoning_var = "ZoneDist1", overlay_var = "Overlay1", lot_area_var = "LotArea", borough = "brooklyn", "CT2010", data = .)
```

#Clean School District Data

```{r}
grad = read_excel("RawData/graduation_rates.xlsx", sheet = "All") %>%
  filter(!!as.name("Cohort Year") == 2007 & Cohort == "4 year June") %>%
  rename(SchoolDist = District)
```

```{r}
grad
```

```{r}
pluto_bk %>%
  filter(grepl("R", ZoneDist1) & !grepl("PARK", ZoneDist1)) %>%
  filter(!is.na(SchoolDist)) %>%
  select(-ZoneDist1, -Overlay1) %>%
  group_by(CT2010) %>%
  mutate(total_area = sum(as.numeric(LotArea))) %>%
  group_by(CT2010, SchoolDist) %>%
  summarise(dist_area = sum(as.numeric(LotArea)/total_area)) %>%
  ungroup() %>%
  inner_join(grad, by = "SchoolDist") %>%
  group_by(CT2010) %>%
  summarize(grad_rate = sum(!!as.name("% Grads")/100 * dist_area))
```


